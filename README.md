# UFRJ InSilico API

Uma API Rest para disponibilizar resultados de modelos meteorol√≥gicos e dados, transformando dados brutos em recursos cient√≠ficos acess√≠veis via endpoints. O mecanismo central para a automa√ß√£o e reutiliza√ß√£o de pesquisas de laborat√≥rio.

## üåä Modelo de Previs√£o de Vaz√£o - Esta√ß√£o Funil (19091)

### Funcionalidades Principais

**Modelo de Ensemble ML**: Sistema h√≠brido usando MLP (Multi-Layer Perceptron) + XGBoost com otimiza√ß√£o por algoritmo gen√©tico para predi√ß√£o de vaz√£o mensal.

**Interface Web Interativa**: Dashboard completo com visualiza√ß√£o temporal, m√©tricas de performance e demonstra√ß√£o da API.

**API Robusta**: Endpoints para predi√ß√£o com valida√ß√£o estrita de todas as vari√°veis de entrada (23 vari√°veis obrigat√≥rias).

## Configura√ß√£o do Ambiente de Desenvolvimento

### M√©todo R√°pido (Recomendado)

```bash
# Executar script de configura√ß√£o autom√°tica
source setup_dev.sh
```

### M√©todo Manual

#### 1. Criar e ativar ambiente virtual

```bash
# Criar ambiente virtual
python3 -m venv venv

# Ativar ambiente virtual (Linux/Mac)
source venv/bin/activate

# Ativar ambiente virtual (Windows)
venv\Scripts\activate
```

#### 2. Instalar depend√™ncias

```bash
pip install -r requirements.txt
```

#### 3. Executar a aplica√ß√£o

```bash
# Desenvolvimento com hot reload (dentro do ambiente virtual)
python3 -m uvicorn app.main:app --reload

# A API estar√° dispon√≠vel em http://localhost:8000
```

#### 4. Acessar documenta√ß√£o

- **P√°gina de Documenta√ß√£o Interativa**: http://localhost:8000/ 
- **Swagger UI (FastAPI)**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

#### 5. Executar testes

```bash
# Executar testes (dentro do ambiente virtual)
python3 -m pytest -v
```

## Executar com Docker

```bash
# Construir imagem
docker build -t ufrj-insilico .

# Executar container
docker run -p 8000:8000 ufrj-insilico
```

## Endpoints Dispon√≠veis

### üåä Modelo de Vaz√£o - Esta√ß√£o Funil (19091)
- `POST /api/models/flow/predict` - Previs√£o de vaz√£o mensal com ensemble ML
- `GET /api/models/flow/status` - Status do modelo e informa√ß√µes de treinamento
- `GET /api/models/flow/test-data` - Dados de teste (2020-2023) com m√©tricas
- `GET /static/flow.html` - Interface web interativa com dashboard completo


### Dados Meteorol√≥gicos
- `GET /api/data/` - Lista dados meteorol√≥gicos com geometrias (filtros opcionais)
- `GET /api/data/points` - Lista apenas dados pontuais
- `GET /api/data/polygons` - Lista apenas dados de √°rea
- `GET /api/data/locations` - Lista localiza√ß√µes dispon√≠veis

### Modelos de ML
- `GET /api/models/` - Lista resultados de modelos com geometrias (filtros opcionais)
- `GET /api/models/points` - Lista previs√µes pontuais
- `GET /api/models/polygons` - Lista previs√µes de √°rea
- `GET /api/models/forecast-areas` - Lista √°reas de previs√£o

### Documenta√ß√£o
- `GET /` - P√°gina de documenta√ß√£o interativa personalizada
- `GET /docs` - Documenta√ß√£o Swagger UI (FastAPI)
- `GET /redoc` - Documenta√ß√£o ReDoc (FastAPI)

## üåä API de Previs√£o de Vaz√£o

### Modelo de Ensemble

O modelo utiliza uma abordagem h√≠brida com dois componentes principais:

- **MLP (Multi-Layer Perceptron)**: Rede neural com arquitetura (64, 32) neur√¥nios
- **XGBoost**: Gradient boosting com `max_depth=5` e `n_estimators=100`
- **Otimiza√ß√£o Gen√©tica**: Algoritmo DEAP para calibra√ß√£o de par√¢metros
- **Mistura Adaptiva**: Gate sazonal para combinar predi√ß√µes dos modelos

### Exemplo de Uso

```bash
curl -X POST "http://localhost:8000/api/models/flow/predict" \
  -H "Content-Type: application/json" \
  -d '{
    "year": 2024,
    "month": 6,
    "u2_min": -1.2,
    "u2_max": 4.5,
    "tmin_min": 16.8,
    "tmin_max": 21.2,
    "tmax_min": 25.3,
    "tmax_max": 30.7,
    "rs_min": 16.4,
    "rs_max": 24.8,
    "rh_min": 62.5,
    "rh_max": 85.2,
    "eto_min": 3.1,
    "eto_max": 5.2,
    "pr_min": 0.0,
    "pr_max": 180.5,
    "y_lag1": 95.6,
    "y_lag2": 87.3,
    "y_lag3": 102.1,
    "y_rm3": 95.0,
    "pr_lag1": 65.2,
    "pr_lag2": 78.9,
    "pr_lag3": 42.1,
    "pr_sum3": 186.2,
    "pr_api3": 89.4
  }'
```

### Resposta da API

```json
{
  "year": 2024,
  "month": 6,
  "predicted_flow": 220.61,
  "lower_bound": 194.14,
  "upper_bound": 247.07,
  "uncertainty": 26.47,
  "confidence_level": 0.83,
  "model_components": {
    "gate": 0.7,
    "sigma_mix": 21.45,
    "s_opt": 1.2
  }
}
```

### Vari√°veis de Entrada (23 obrigat√≥rias)

#### Meteorol√≥gicas (14 vari√°veis)
- **Vento**: `u2_min`, `u2_max` (m/s)
- **Temperatura**: `tmin_min`, `tmin_max`, `tmax_min`, `tmax_max` (¬∞C)
- **Radia√ß√£o**: `rs_min`, `rs_max` (MJ/m¬≤/dia)
- **Umidade**: `rh_min`, `rh_max` (%)
- **Evapotranspira√ß√£o**: `eto_min`, `eto_max` (mm/dia)
- **Precipita√ß√£o**: `pr_min`, `pr_max` (mm)

#### Lags de Vaz√£o (4 vari√°veis)
- `y_lag1`, `y_lag2`, `y_lag3`: Vaz√µes dos 3 meses anteriores (m¬≥/s)
- `y_rm3`: M√©dia m√≥vel de 3 meses (m¬≥/s)

#### Lags de Precipita√ß√£o (5 vari√°veis)
- `pr_lag1`, `pr_lag2`, `pr_lag3`: Precipita√ß√£o dos 3 meses anteriores (mm)
- `pr_sum3`: Soma dos 3 meses anteriores (mm)
- `pr_api3`: √çndice de precipita√ß√£o antecedente (mm)

### Performance do Modelo

M√©tricas calculadas no conjunto de teste (2020-2023):

- **MAE**: ~25.4 m¬≥/s (Erro Absoluto M√©dio)
- **RMSE**: ~35.8 m¬≥/s (Raiz do Erro Quadr√°tico M√©dio)
- **R¬≤**: ~0.85 (Coeficiente de Determina√ß√£o)
- **NSE**: ~0.84 (Nash-Sutcliffe Efficiency)
- **Cobertura**: ~83% (Observa√ß√µes dentro do intervalo de predi√ß√£o)

### Par√¢metros de Filtro

#### `/api/data/` e `/api/models/`
- `geometry_type`: Filtrar por tipo de geometria (`Point` ou `Polygon`)
- `data_type`: Filtrar por tipo de dado (`temperature`, `humidity`, etc.)
- `model_name`: Filtrar por nome do modelo (apenas em `/models/`)

## üìä Interface Web do Modelo de Vaz√£o

### Dashboard Interativo (`/static/flow.html`)

**Visualiza√ß√£o Temporal**:
- Gr√°fico de s√©rie temporal (2020-2023) comparando observado vs previsto
- Bandas de incerteza das previs√µes (amarela) 
- Bandas de variabilidade dos dados observados (cinza)
- M√©tricas de performance em tempo real

**Demonstra√ß√£o da API**:
- Campo JSON edit√°vel com todas as 23 vari√°veis
- Bot√£o para carregar exemplos aleat√≥rios dos dados de teste
- Teste direto da API com feedback de status HTTP e tempo de resposta
- Valida√ß√£o autom√°tica de JSON e tratamento de erros

### Caracter√≠sticas T√©cnicas

- **Responsivo**: Funciona em desktop, tablet e mobile
- **Tempo Real**: Indicador de status do modelo
- **Interativo**: Plotly.js para gr√°ficos din√¢micos
- **Valida√ß√£o Estrita**: Todas as 23 vari√°veis obrigat√≥rias

## Estrutura dos Dados

### Dados Meteorol√≥gicos (`/data/`)

Os dados incluem geometrias GeoJSON para localiza√ß√£o espacial:

```json
{
  "id": 1,
  "type": "temperature",
  "value": 25.3,
  "unit": "C",
  "timestamp": "2025-09-29T12:00:00Z",
  "geometry": {
    "type": "Point",
    "coordinates": [-43.1729, -22.9068]
  },
  "location_name": "Campus UFRJ - Cidade Universit√°ria"
}
```

### Resultados de Modelos (`/models/`)

Os resultados incluem previs√µes com geometrias e metadados adicionais:

```json
{
  "id": 1,
  "model": "rain_prediction",
  "result": "rain",
  "confidence": 0.87,
  "timestamp": "2025-09-29T12:00:00Z",
  "forecast_time": "2025-09-29T18:00:00Z",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[[-43.73, -22.82], [-43.10, -22.82], ...]]
  },
  "location_name": "Zona Oeste do Rio de Janeiro"
}
```

### Tipos de Geometria Suportados

- **Point**: Localiza√ß√£o espec√≠fica (esta√ß√£o meteorol√≥gica, sensor)
- **Polygon**: √Årea de cobertura (regi√£o metropolitana, zona de previs√£o)

## üåê Interface Web Interativa

A aplica√ß√£o inclui uma p√°gina web moderna e responsiva que serve como:

### üìã Documenta√ß√£o T√©cnica Completa
- Vis√£o geral da API e funcionalidades
- Explica√ß√£o detalhada de cada endpoint
- Exemplos de estruturas de dados
- Guia de par√¢metros dispon√≠veis

### üß™ Ambiente de Testes Interativo
- **Testes r√°pidos**: Bot√µes para testar cada endpoint individualmente
- **Playground avan√ßado**: Interface para construir requisi√ß√µes personalizadas
- **Filtros din√¢micos**: Sele√ß√£o de par√¢metros por tipo de geometria, modelo, etc.
- **Resultados formatados**: JSON com syntax highlighting e bot√µes de c√≥pia

### üìä Funcionalidades Avan√ßadas
- **Status da API**: Indicador em tempo real do status do servidor
- **Navega√ß√£o fluida**: Menu sticky com scroll suave entre se√ß√µes
- **Design responsivo**: Interface adapt√°vel para desktop, tablet e mobile
- **Tempo de resposta**: Medi√ß√£o e exibi√ß√£o do tempo de cada requisi√ß√£o
- **C√≥pia f√°cil**: Bot√µes para copiar resultados JSON para clipboard

### üé® Interface Moderna
- Design clean e profissional
- Gradientes e anima√ß√µes sutis
- √çcones intuitivos e cores sem√¢nticas
- Layout em grid responsivo

## üß™ Scripts de Treinamento e An√°lise

### Treinamento do Modelo
```bash
# Treinar modelos e salvar para produ√ß√£o
python scripts/train_and_save_models.py

# Executar l√≥gica completa do notebook (desenvolvimento)
python scripts/run_funil_model.py
```

### Dados de Teste
- **Per√≠odo**: 2020-2023 (48 meses)
- **Treinamento**: 1998-2017 (20 anos)
- **Fonte**: Esta√ß√£o 19091 (Funil) - dados meteorol√≥gicos + vaz√£o observada
- **Localiza√ß√£o**: `modelos_staging/flow/agragado_meteo_vazao_shifted_station_19091_extended.csv`

## Estrutura do Projeto

```
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                    # Aplica√ß√£o principal FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ routers/                   # Defini√ß√£o dos endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data.py               # Endpoints para dados meteorol√≥gicos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models.py             # Endpoints para modelos (+ vaz√£o)
‚îÇ   ‚îú‚îÄ‚îÄ models/                    # Modelos de Machine Learning
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ flow_model.py         # Modelo completo de vaz√£o (refer√™ncia)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ optimized_flow_model.py # Modelo otimizado para produ√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ saved_models/         # Modelos treinados (.joblib)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ mlpA_model.joblib
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ xgbA_model.joblib
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ mlpB_model.joblib
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ xgbB_model.joblib
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ scaler.joblib
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ training_info.joblib
‚îÇ   ‚îî‚îÄ‚îÄ mocks/                    # Dados mockados para desenvolvimento
‚îÇ       ‚îú‚îÄ‚îÄ data_mock.py         # Mock de dados meteorol√≥gicos
‚îÇ       ‚îî‚îÄ‚îÄ models_mock.py       # Mock de resultados de modelos
‚îú‚îÄ‚îÄ scripts/                      # Scripts de treinamento e an√°lise
‚îÇ   ‚îú‚îÄ‚îÄ train_and_save_models.py # Treinar e salvar modelos para produ√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ run_funil_model.py       # Executar l√≥gica completa do notebook
‚îú‚îÄ‚îÄ modelos_staging/             # Dados e notebooks de desenvolvimento
‚îÇ   ‚îî‚îÄ‚îÄ flow/
‚îÇ       ‚îú‚îÄ‚îÄ VAZ√ÉO_FUNIL.ipynb   # Notebook original v6.8
‚îÇ       ‚îî‚îÄ‚îÄ agragado_meteo_vazao_shifted_station_19091_extended.csv
‚îú‚îÄ‚îÄ static/                      # Interface web
‚îÇ   ‚îú‚îÄ‚îÄ flow.html               # Dashboard do modelo de vaz√£o
‚îÇ   ‚îú‚îÄ‚îÄ flow-script.js          # JavaScript da interface
‚îÇ   ‚îú‚îÄ‚îÄ flow-styles.css         # Estilos CSS da interface
‚îÇ   ‚îú‚îÄ‚îÄ index.html              # P√°gina principal da API
‚îÇ   ‚îú‚îÄ‚îÄ script.js               # JavaScript geral
‚îÇ   ‚îî‚îÄ‚îÄ styles.css              # Estilos CSS gerais
‚îú‚îÄ‚îÄ tests/                       # Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ test_flow_model.py      # Testes do modelo de vaz√£o
‚îÇ   ‚îú‚îÄ‚îÄ test_data.py            # Testes dos endpoints de dados
‚îÇ   ‚îî‚îÄ‚îÄ test_models.py          # Testes gerais dos modelos
‚îú‚îÄ‚îÄ requirements.txt             # Depend√™ncias Python
‚îú‚îÄ‚îÄ Dockerfile                   # Configura√ß√£o Docker
‚îú‚îÄ‚îÄ setup_dev.sh                # Script de configura√ß√£o do ambiente
‚îî‚îÄ‚îÄ README.md                   # Documenta√ß√£o do projeto
```

## üöÄ Pr√≥ximos Passos

### Melhorias Planejadas
- [ ] Implementa√ß√£o de novos modelos para outras esta√ß√µes
- [ ] API de retreinamento autom√°tico
- [ ] Cache Redis para predi√ß√µes frequentes  
- [ ] Monitoramento e logging avan√ßado
- [ ] Exporta√ß√£o de dados em m√∫ltiplos formatos
- [ ] Dashboard de administra√ß√£o para gerenciar modelos

### Contribui√ß√µes
Contribui√ß√µes s√£o bem-vindas! Por favor, abra uma issue ou pull request para sugest√µes de melhorias.
